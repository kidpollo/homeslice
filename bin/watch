#!/usr/bin/env ruby

require 'open-uri'

if ARGV.grep(/(-h|--help)/).any?
  puts "watch <watcher> <watchee> <github-token> [--no-forks]"
  puts "options:"
  puts "  --help     -h  display this help"
  puts "  --no-forks     ignore forked repositories"
  exit 0
end

no_fork  = ARGV.delete('--no-forks')

watcher = ARGV.shift
watchee = ARGV.shift
token   = ARGV.shift
watched = YAML::load(open("http://github.com/api/v2/yaml/repos/watched/#{watcher}"))['repositories']

following = YAML::load(open("http://github.com/api/v2/yaml/user/show/#{watcher}/following"))['users']
if following.include?(watchee)
  puts "Following #{watchee}"
else
  follow_uri = "http://github.com/api/v2/yaml/user/follow/#{watchee}"
  system("curl -F 'login=#{watcher}' -F 'token=#{token}' #{follow_uri}")
end

YAML::load(open("http://github.com/api/v2/yaml/repos/show/#{watchee}"))['repositories'].each do |repo|
  if repo[:fork] && no_fork
    puts "Skipping #{repo[:name]} [forked]"
    next
  end
  if watched.any?{ |watched_repo| watched_repo[:url] == repo[:url] }
    puts "Watching #{repo[:name]}"
  else
    watch_uri = "http://github.com/api/v2/yaml/repos/watch/#{watchee}/#{repo[:name]}"
    system("curl -F 'login=#{watcher}' -F 'token=#{token}' #{watch_uri}")
  end
end
